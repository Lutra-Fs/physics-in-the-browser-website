(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[94],{8416:function(t,e,i){(window.__NEXT_P=window.__NEXT_P||[]).push(["/simDraft",function(){return i(200)}])},200:function(t,e,i){"use strict";i.r(e),i.d(e,{default:function(){return y}});var r=i(5893),n=i(9034),o=i.n(n),s=i(5029),a=i(1033),h=i(4737),c=i(9477),l=i(5078),d=i(7294),u=i(8736);class m{static async createModelService(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[64,64],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:5;console.log("createModelService called");let n=new m;return console.log("createModelService constructor called"),await n.init(t,e,i,r),console.log("createModelService finished"),n}async initMatrixFromPath(t){"/"===t[0]&&(t="".concat("https://techlauncher-mlai-edge-physics.github.io","/").concat(t)),console.log("initMatrixFromPath called with path: ".concat(t));let e=await fetch(t).then(async t=>await t.json());if(null==e)throw Error("The matrix from ".concat(t," is null"));this.initMatrixFromJSON(this.normalizeMatrix(e))}bindOutput(t){this.outputCallback=t}async startSimulation(){this.isPaused=!1,this.iterate().catch(t=>{console.error("error in iterate",t),this.isPaused=!0})}pauseSimulation(){this.isPaused=!0}async init(t,e,i,r){console.log("init called"),this.session=await u.InferenceSession.create(t,{executionProviders:["wasm"],graphOptimizationLevel:"all"}),console.log("init session created"),this.channelSize=r,this.gridSize=e,this.batchSize=i,this.tensorShape=[i,e[0],e[1],r],this.tensorSize=i*e[0]*e[1]*r}initMatrixFromJSON(t){if(console.log("initMatrixFromJSON called"),this.matrixArray=new Float32Array(t.flat(1/0)),this.matrixArray.length!==this.tensorSize)throw Error("matrixArray length ".concat(this.matrixArray.length," does not match tensorSize ").concat(this.tensorSize))}async iterate(){if(null==this.session)throw Error("session is null, createModelServices() must be called at first");console.log("iterate called"),console.log("this.matrixArray",this.matrixArray);let t=new u.Tensor("float32",this.matrixArray,this.tensorShape),e={};e[this.session.inputNames[0]]=t,this.session.run(e).then(t=>{console.log("outputs type",typeof t),t.Output.data instanceof Float32Array&&(this.outputCallback(t.Output.data),this.copyOutputToMatrix(t.Output.data),setTimeout(()=>{this.isPaused||this.iterate().catch(t=>{console.error("error in iterate",t),this.isPaused=!0})}))}).catch(t=>{console.error("error in session.run",t),this.isPaused=!0})}normalizeMatrix(t){for(let e=0;e<this.channelSize;e++){let i=0;for(let r=0;r<this.batchSize;r++)for(let n=0;n<this.gridSize[0];n++)for(let o=0;o<this.gridSize[1];o++)i+=t[r][n][o][e];this.meanArray.push(Math.sqrt(i/(this.batchSize*this.gridSize[0]*this.gridSize[1]))),i=0;for(let r=0;r<this.batchSize;r++)for(let n=0;n<this.gridSize[0];n++)for(let o=0;o<this.gridSize[1];o++)t[r][n][o][e]-=this.meanArray[e],i+=t[r][n][o][e]**2;this.stdArray.push(i/(this.batchSize*this.gridSize[0]*this.gridSize[1]));for(let i=0;i<this.batchSize;i++)for(let r=0;r<this.gridSize[0];r++)for(let n=0;n<this.gridSize[1];n++)t[i][r][n][e]/=this.stdArray[e]}return t}copyOutputToMatrix(t){if(0===this.matrixArray.length)throw Error("matrixArray is empty");let e=0,i=0,r=0;for(;e<t.length;){if(r>=3&&(r=0,(i+=2)>=this.matrixArray.length))throw Error("toIndex ".concat(i," exceeds matrixArray length ").concat(this.matrixArray.length));this.matrixArray[i]=t[e],e++,i++,r++}if(e!==t.length)throw Error("fromIndex ".concat(e," does not match outputs length ").concat(t.length));if(i+2!==this.matrixArray.length)throw Error("toIndex ".concat(i," does not match matrixArray length ").concat(this.matrixArray.length))}updateForce(t,e){let i=this.getIndex(t);this.matrixArray[i+3]+=e.x,this.matrixArray[i+4]+=e.y}getIndex(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return e*this.gridSize[0]*this.gridSize[1]+t.y*this.gridSize[0]+t.x}constructor(){this.session=null,this.matrixArray=new Float32Array,this.gridSize=[0,0],this.batchSize=0,this.tensorShape=[0,0,0,0],this.tensorSize=0,this.isPaused=!0,this.stdArray=[],this.meanArray=[],this.channelSize=0}}function g(t){let e=(0,d.useRef)(null);(0,l.A)(t=>{t.camera.setRotationFromAxisAngle(new c.Vector3(1,0,0),-Math.PI/2),e.current.lookAt(0,99,0)});let i={segX:"9.0",segY:"9.0",width:"2.0",height:"2.0",segXInt:"10",segArea:"4096",densityRangeLow:"0.0",densityRangeHigh:"100.0",densityRangeSize:"100.0"},n=new c.ShaderMaterial;n.vertexShader="// VERTEX SHADER\r\nvarying lowp vec4 vColor;\r\n\r\nuniform float density[300]; //the size of one chunk \r\n\r\nint getIndexFromPoint(vec3 pos)\r\n{\r\n  int ix = int((pos.x + (${width} / 2.0)) * ${segX} / ${width});\r\n  int iy = int((-pos.y + (${height} / 2.0)) * ${segY} / ${height});\r\n  return (ix + iy * ${segXInt})*3; // skip the other 2 elements\r\n}\r\n\r\nvec4 getColourFromDensity(float density)\r\n{\r\n  density = min(density, ${densityRangeHigh});\r\n  density = max(density, ${densityRangeLow});\r\n  density = density / ${densityRangeSize};\r\n  return vec4(density, 0.0, 1.0 - density, 1.0);\r\n}\r\n\r\nvoid main(void) \r\n{\r\n  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\r\n\r\n  int index = getIndexFromPoint(position);\r\n  vColor = getColourFromDensity(density[index]);\r\n}".replace(/\$\{(\w+?)\}/g,function(t,e){return void 0!==i[e]?i[e]:"1.0"}),n.fragmentShader="// FRAGMENT SHADER\r\nvarying lowp vec4 vColor;\r\n\r\nvoid main(void) {\r\n  gl_FragColor = vColor;\r\n}\r\n",n.uniforms={density:{value:null}};let o="".concat("https://techlauncher-mlai-edge-physics.github.io","/initData/pvf_incomp_44_0.json");return m.createModelService("../_next/static/chunks/pages/model/bno_small.onnx",[64,64],10).then(t=>{t.bindOutput(s),t.initMatrixFromPath(o).then(()=>{t.startSimulation()})}),(0,r.jsx)("mesh",{...t,ref:e,material:n,children:(0,r.jsx)("planeGeometry",{args:[2,2,9,9]})});function s(t){let e=t.slice(0,300);n.uniforms.density.value=e,n.uniformsNeedUpdate=!0}}function y(){return(0,r.jsx)("div",{className:o().scene,children:(0,r.jsxs)(s.Xz,{shadows:!0,className:o().canvas,camera:{position:[1,10,1]},children:[(0,r.jsx)("ambientLight",{}),(0,r.jsx)(a.j,{}),(0,r.jsx)(g,{position:[0,0,0]}),(0,r.jsx)(h.o,{})]})})}},9034:function(t){t.exports={main:"Home_main__nLjiQ",description:"Home_description__41Owk",code:"Home_code__suPER",grid:"Home_grid__GxQ85",card:"Home_card___LpL1",center:"Home_center__4BFgC",logo:"Home_logo__27_tb",thirteen:"Home_thirteen__cMI_k",rotate:"Home_rotate____XsI",content:"Home_content__Zy02X",vercelLogo:"Home_vercelLogo__dtSk9",scene:"Home_scene__X8N8q",canvas:"Home_canvas__x616u",body:"Home_body__XYSzx"}}},function(t){t.O(0,[774,770,737,240,58,888,179],function(){return t(t.s=8416)}),_N_E=t.O()}]);